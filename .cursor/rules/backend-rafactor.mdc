---
description: 
globs: 
alwaysApply: false
---
---
description: Migration plan and feature parity checklist for replacing Express backend with Supabase and edge functions
globs:
  - "**/*.ts"
alwaysApply: false
---

# ğŸ§± Backend Refactor: Express â†’ Supabase

## ğŸ¯ Goal

Migrate core backend functionality from Express to Supabase, focusing first on Supabase Edge Functions for LERG data flow and health checks. Authentication and access control will follow in a later phase.

---

## âœ… Phase 1: Supabase Function Deployment (No Auth Yet)

- [x] â¬†ï¸ Deploy `upload-lerg` edge function
- [x] â¬†ï¸ Deploy `get-lerg-data` edge function
- [x] âœ… `ping-status` already deployed
- [x] ğŸ—‘ï¸ Delete `hello-world` edge function from Supabase dashboard
- [x] ğŸ§¹ Remove `hello-world` folder locally (`/supabase/functions/hello-world`)
- [x] ğŸ” Add `console.log` statements for debugging in `upload-lerg`
- [x] ğŸ” Add `console.log` statements for debugging in `get-lerg-data`
- [x] âœ… Verify local function testing with `supabase functions serve`
- [x] âœ… Run `supabase functions deploy upload-lerg`
- [x] âœ… Run `supabase functions deploy get-lerg-data`

---

## ğŸ”— Phase 2: Client Integration

- [ ] ğŸ” Replace old `/upload/lerg` client call with `upload-lerg` function
- [ ] ğŸ” Replace LERG meta fetch (if any) with `get-lerg-data`
- [ ] ğŸ’¾ Use Dexie to store downloaded LERG data from `get-lerg-data`
- [ ] âš ï¸ Add error handling and response checks for `{ data, error }` pattern
- [ ] âœ… Validate LERG CSV format in frontend before uploading

---

## ğŸŒ Phase 3: Ping Status Integration

- [ ] ğŸ”„ Use `ping-status` in components that need backend health status
- [ ] ğŸ”„ Add retry/fallback logic in client if ping fails
- [ ] âœ… Confirm ping function returns `{ data: { status: 'ok' } }`

---

## ğŸ—‚ï¸ Phase 4: Supabase Schema & RLS Prep

- [ ] ğŸ“¦ Create `lerg_codes` table in Supabase
- [ ] ğŸ” Add indexes on `npa`, `nxx`, and `ocn` (or equivalent fields)
- [ ] ğŸš§ Add row-level security policy (read-only for now)
- [ ] ğŸ§ª Verify manual insert via Supabase Studio
- [ ] âœ… Add `last_updated` column for syncing logic later

---

## ğŸ§  Phase 5: Deferred (Auth + Roles)

_(To be tackled after LERG + Edge pipeline is working well)_

- [ ] ğŸ”’ Set up Supabase Auth (email/password)
- [ ] ğŸ­ Create `superadmin` role and assign to your account
- [ ] ğŸ›¡ï¸ Add role check to `upload-lerg` edge function
- [ ] ğŸ” Lock `get-lerg-data` behind authenticated users
- [ ] ğŸ”„ Update frontend to support login/session/token

---

## ğŸ§¼ Phase 6: Cleanup & Docs

- [ ] ğŸ§¹ Remove `/server` folder and all Express code
- [ ] ğŸ§¹ Delete unused middleware/utilities from project
- [ ] ğŸ§¼ Update README.mdc to reflect Supabase-only setup
- [ ] ğŸ§ª Smoke test all flows:
  - [ ] Upload CSV via `upload-lerg`
  - [ ] Download and parse via `get-lerg-data`
  - [ ] Use Dexie to store and read
  - [ ] `ping-status` integrated in client
- [ ] ğŸ Remove Express from `dev` and `build` scripts

---

## ğŸ“ Notes

- Dexie remains the primary client-side DB
- All edge functions follow `{ data, error }` format
- Auth will be minimal or disabled for now to allow dev freedom
- Add console logs in Supabase Edge Functions during early testing
