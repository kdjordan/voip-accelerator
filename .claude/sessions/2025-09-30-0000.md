# Development Session: 2025-09-30 00:00 - Subscription Simplification

## Session Overview
**Start Time:** 2025-09-30 00:00
**Status:** Active - Planning Phase Complete
**Duration Estimate:** 16-21 hours total work

## Goals

### Primary Objective
Simplify subscription system from complex 3-tier model to simple single-plan with monthly/annual billing options.

### Business Requirements
- **Remove:** Optimizer ($99/mo, 100 uploads), Accelerator ($249/mo), Enterprise ($499/mo, 5 seats)
- **Replace with:** Single "Accelerator Plan"
  - Monthly: $99/month
  - Annual: $999/year (save $189/year)
- **Features:** Unlimited uploads, single concurrent session, 7-day free trial
- **Keep:**
  - Session management for single-login enforcement
  - Simple `total_uploads` counter (admin-only analytics, hidden from users)
- **Remove:**
  - All upload limits and monthly tracking
  - Multi-seat organization support
  - `super_admin` role (keep only `user` and `admin`)


### Success Criteria
- All tier-based logic removed
- Stripe integration updated for new pricing
- Database schema simplified
- UI components updated to reflect new model
- All tests passing
- Zero service disruption for existing customers

## Detailed Plan

**Comprehensive migration plan created:** `.claude/docs/SUBSCRIPTION_SIMPLIFICATION_PLAN.md`

### Work Division

#### Agent #1: Backend & Infrastructure (6-8 hours)
**Responsibilities:**
- Database schema migration (remove tiers, organizations, simplify upload tracking to `total_uploads` counter)
- Remove `super_admin` role, keep only `user` and `admin`
- Stripe product creation and price ID configuration
- Edge function updates (webhook handlers, checkout, upgrades)
- Simplify `track-upload` edge function to just increment counter
- Session management simplification
- Database function cleanup

**Key Tasks:**
1. Create migration to drop `subscription_tier`, `organizations`, monthly upload tracking
2. Add `billing_period` column ('monthly' | 'annual')
3. Add/Keep `total_uploads` column for simple counter
4. Update `role` constraint: remove `super_admin`, keep `user` | `admin`
5. Migrate existing `super_admin` users to `admin`
6. Update Stripe webhook to detect billing period by amount ($99 vs $999)
7. Simplify `increment_upload_count()` to just increment `total_uploads`
8. Simplify `track-upload` edge function (no limit checking)
9. Simplify session validation (remove Enterprise exemptions)
10. Create new Stripe products: "Accelerator Plan - Monthly/Annual"
11. Archive old Stripe products

#### Agent #2: Frontend & User Interface (8-10 hours)
**Responsibilities:**
- Type system updates (remove tiers, add billing period, remove `super_admin`)
- User store simplification
- Simplify upload tracking composable (remove limits, keep increment only)
- Remove upload limit UI components (banners, modals)
- Update billing/pricing UI components
- Simplify plan selection to billing period toggle
- Remove enterprise features from UI
- Add `total_uploads` column to admin user management (analytics)
- Test updates

**Key Tasks:**
1. Update `user-types.ts` - remove tier types, add BillingPeriod, remove `super_admin` from role type
2. Simplify user store getters (remove tier/upload limit logic)
3. Simplify `useUploadTracking.ts` (remove limits, keep increment)
4. Delete upload limit UI components (banners, modals)
5. Rewrite PlanSelectorModal as billing period toggle
6. Remove TierSelectionStep from signup flow
7. Update BillingPage, PricingSection to show "Accelerator Plan" monthly/annual
8. Remove EnterpriseView and organization UI
9. Update UserManagement.vue - remove `super_admin`, add `total_uploads` column
10. Update all tests for new model

### Integration Points
- Agent #1 provides new Stripe price IDs for Agent #2 environment variables
- Agent #1 defines Profile schema (billing_period) for Agent #2 types
- Both agents coordinate on session management behavior (keep single-login enforcement)

## Progress

### Agent #1 Progress
**Status:** Ready to start
**Estimated Time:** 6-8 hours

#### Pending Tasks
- [ ] Create database migration file
- [ ] Create new Stripe products (Monthly $99, Annual $999)
- [ ] Update stripe-events webhook handler
- [ ] Update create-checkout-session edge function
- [ ] Update upgrade-subscription edge function
- [ ] Delete obsolete edge functions (7 files)
- [ ] Remove upload tracking database functions
- [ ] Simplify session validation logic
- [ ] Test database migration on staging
- [ ] Test Stripe webhooks in test mode

### Agent #2 Progress
**Status:** Ready to start (waiting for Stripe price IDs from Agent #1)
**Estimated Time:** 8-10 hours

#### Pending Tasks
- [ ] Update user-types.ts (remove tiers, add BillingPeriod)
- [ ] Simplify user-store.ts (remove upload/tier logic)
- [ ] Delete useUploadTracking.ts
- [ ] Delete upload limit UI components (3 files)
- [ ] Rewrite PlanSelectorModal.vue
- [ ] Delete TierSelectionStep.vue
- [ ] Update billing page components
- [ ] Update home/pricing components
- [ ] Delete EnterpriseView.vue
- [ ] Update router (remove enterprise routes)
- [ ] Update navigation components
- [ ] Update test files and test helpers
- [ ] Full TypeScript compilation check
- [ ] End-to-end testing

## Key Decisions

### Architecture Decisions
1. **Keep Session Management:** Single-login enforcement remains for all users (prevents account sharing)
2. **Remove Upload Tracking Completely:** No need to track uploads since all plans are unlimited
3. **Migrate Existing Users:** All paid users → monthly billing at current price, trials remain trials
4. **Archive Old Stripe Products:** Don't delete (preserves historical data), mark as archived
5. **Two-Week Trial:** Standardize to 14 days (currently inconsistent 7 days in some places)

### Migration Strategy
1. **Staging First:** Deploy and test in staging environment before production
2. **Database Backup:** Full backup before running migration
3. **Graceful Handling:** Existing users maintain access during transition
4. **Rollback Plan:** Keep old schema/functions available for quick rollback if needed

### Technical Approach
- **Billing Period over Tiers:** Replace `subscription_tier` with `billing_period` ('monthly'|'annual')
- **Stripe Amount Detection:** Webhook determines billing period by amount (9900 = monthly, 99900 = annual)
- **Simplified Route Guards:** Change from tier-based to simple trial vs active checks
- **No Upload Limits:** Remove all upload count tracking, validation, and UI

## Technical Notes

### Database Changes Summary
**Tables to Drop:**
- `organizations`
- `organization_invitations`
- `upload_history`

**Columns to Drop from `profiles`:**
- `subscription_tier`
- `uploads_this_month`
- `uploads_reset_date`
- `organization_id`
- `selected_tier`
- `trial_tier`

**Columns to Add/Keep in `profiles`:**
- `billing_period` (text, nullable, 'monthly' | 'annual')
- `total_uploads` (integer, default 0) - simple counter for admin analytics

**Role System Changes:**
- Update `role` constraint: remove `'super_admin'`, keep only `'user' | 'admin'`
- Migrate existing `super_admin` → `admin`

### Stripe Configuration
**New Products:**
- Accelerator Plan - Monthly: $99.00 (9900 cents)
- Accelerator Plan - Annual: $999.00 (99900 cents)

**Old Products (to archive):**
- Optimizer: $99/mo
- Accelerator: $249/mo
- Enterprise: $499/mo

### Code Changes Summary
**Files to SIMPLIFY (keep but remove limit logic):**
- `useUploadTracking.ts` - Remove limit checking, keep increment
- `track-upload` edge function - Simplify to just increment counter

**28 files to DELETE:**
- 6 edge functions (organizations, tier setting)
- 4 UI components (upload limits, tier selection, enterprise)
- 1 composable (global upload limits)
- 1 page (EnterpriseView)
- Documentation files

**40+ files to MODIFY:**
- Types (remove tiers, `super_admin`)
- Stores (simplify user store)
- Components (billing, pricing, admin)
- Services (Stripe integration)
- Tests (update for new model)
- Migrations (database schema)

### Environment Variables
**Add:**
- `VITE_STRIPE_PRICE_MONTHLY_ACCELERATOR`
- `VITE_STRIPE_PRICE_ANNUAL_ACCELERATOR`

**Remove:**
- `VITE_STRIPE_PRICE_OPTIMIZER`
- `VITE_STRIPE_PRICE_ACCELERATOR`
- `VITE_STRIPE_PRICE_ENTERPRISE`
- `VITE_OPTIMIZER_UPLOAD_LIMIT`

## Next Steps

### Immediate Actions
1. **Agent #1:** Create Stripe products and note price IDs
2. **Agent #1:** Create database migration file
3. **Agent #2:** Wait for price IDs, then update environment variables
4. **Both:** Review detailed plan in `.claude/SUBSCRIPTION_SIMPLIFICATION_PLAN.md`

### Coordination Points
- Agent #1 must complete Stripe setup before Agent #2 can test checkout flows
- Database migration must complete before frontend changes are deployed
- Both agents should test in staging before production deployment

### Testing Strategy
1. **Unit Tests:** Update all tests for new billing_period model
2. **Integration Tests:** End-to-end signup → payment → subscription flows
3. **Webhook Tests:** Verify Stripe webhooks correctly set billing_period
4. **Manual Testing:** Test all user flows in staging environment
5. **Migration Testing:** Test existing user data migration

## Risk Management

### High Priority Risks
1. **Data Loss:** Existing customer data could be corrupted during migration
   - **Mitigation:** Full database backup, test migration in staging first
2. **Stripe Webhook Failures:** New webhook logic could break payment processing
   - **Mitigation:** Test mode webhooks, gradual rollout, rollback plan
3. **Service Disruption:** Users could lose access during migration
   - **Mitigation:** Zero-downtime migration strategy, keep old functions until verified

### Medium Priority Risks
1. **TypeScript Errors:** Type changes could cause compilation failures
   - **Mitigation:** Incremental type updates, strict compilation checks
2. **Session Logic Bugs:** Removing Enterprise exemptions could affect session handling
   - **Mitigation:** Comprehensive session management testing
3. **UI Inconsistencies:** Removing tiers could leave orphaned UI references
   - **Mitigation:** Global search for tier references, thorough UI review

## Timeline

### Phase 1: Backend Setup (Agent #1) - 3 hours
- Create Stripe products
- Write database migration
- Update webhook handler

### Phase 2: Edge Functions (Agent #1) - 3 hours
- Update checkout/upgrade functions
- Delete obsolete functions
- Test in staging

### Phase 3: Frontend Types & Stores (Agent #2) - 3 hours
- Update types
- Simplify user store
- Remove upload tracking

### Phase 4: UI Components (Agent #2) - 4 hours
- Update billing/pricing components
- Remove enterprise features
- Update navigation

### Phase 5: Testing (Both) - 3 hours
- Unit tests
- Integration tests
- End-to-end testing

### Phase 6: Deployment - 2 hours
- Staging deployment
- Production deployment
- Monitor for issues

**Total Estimated Time: 16-21 hours**

